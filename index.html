<script>
// === YOUR FIREBASE CONFIG ===
const firebaseConfig = {
  apiKey: "AIzaSyDWq8tpm1nksGyeG79C3mGh1VAjGE5vr54",
  authDomain: "arma-tracker.firebaseapp.com",
  projectId: "arma-tracker",
  storageBucket: "arma-tracker.firebasestorage.app",
  messagingSenderId: "109996828590",
  appId: "1:109996828590:web:9deff298f0fe36a07eca3f"
};
// =============================================

// Use Firebase v9 Compat (required for firebase.firestore())
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const eventsRef = db.collection('events');

let events = [];
let chart = null;
const status = document.getElementById('status');

// Real-time listener
eventsRef.orderBy('timestamp', 'asc').onSnapshot(snapshot => {
  events = [];
  snapshot.forEach(doc => {
    const data = doc.data();
    events.push({id: doc.id, date: data.date, type: data.type});
  });
  renderLog();
  status.textContent = `HQ Connected â€“ ${events.length} events`;
}, err => {
  status.textContent = `Connection failed: ${err.message}`;
  console.error(err);
});

function addEvent() {
  const date = document.getElementById('eventDate').value;
  const type = document.getElementById('eventType').value;
  if (!date) return alert('Select date');

  eventsRef.add({
    date,
    type,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    document.getElementById('eventDate').value = '';
  }).catch(err => alert('Failed to save: ' + err.message));
}

function removeEvent(id) {
  if (confirm('Delete event?')) {
    eventsRef.doc(id).delete().catch(err => alert('Delete failed: ' + err.message));
  }
}

function renderLog() {
  const tbody = document.querySelector('#logTable tbody');
  tbody.innerHTML = '';
  events.forEach(e => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${formatDate(e.date)}</td><td>${e.type}</td>
                    <td><button class="delete-btn" onclick="removeEvent('${e.id}')">X</button></td>`;
    tbody.appendChild(tr);
  });
}

function formatDate(d) {
  const date = new Date(d);
  return date.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
}

function generateReport() {
  const month = parseInt(document.getElementById('month').value) - 1;
  const year = parseInt(document.getElementById('year').value);
  const monthName = new Date(year, month).toLocaleString('default', {month:'long'});

  document.getElementById('reportTitle').textContent = `${monthName.toUpperCase()} ${year}`;
  document.getElementById('report').style.display = 'block';
  document.getElementById('chartContainer').style.display = 'block';

  const counts = [{j:0,i:0,p:0,l:0},{j:0,i:0,p:0,l:0},{j:0,i:0,p:0,l:0},{j:0,i:0,p:0,l:0}];
  const daily = {};

  events.forEach(e => {
    const d = new Date(e.date);
    if (d.getMonth() !== month || d.getFullYear() !== year) return;
    const day = d.getDate();
    const week = day <= 7 ? 0 : day <= 14 ? 1 : day <= 21 ? 2 : 3;
    const w = counts[week];
    if (e.type==='Join') w.j++; else if (e.type==='Interview') w.i++;
    else if (e.type==='Promotion') w.p++; else if (e.type==='Leave') w.l++;

    const key = d.toISOString().split('T')[0];
    daily[key] = (daily[key]||0) + (e.type==='Join'?1:e.type==='Leave'?-1:0);
  });

  const rows = document.querySelectorAll('#reportTable tbody tr');
  for (let i=0; i<4; i++) {
    const w = counts[i];
    rows[i].children[1].textContent = w.j;
    rows[i].children[2].textContent = w.i;
    rows[i].children[3].textContent = w.p;
    rows[i].children[4].textContent = w.l;
  }
  const total = counts.reduce((a,b)=>({j:a.j+b.j, i:a.i+b.i, p:a.p+b.p, l:a.l+b.l}), {j:0,i:0,p:0,l:0});
  rows[4].children[1].textContent = total.j;
  rows[4].children[2].textContent = total.i;
  rows[4].children[3].textContent = total.p;
  rows[4].children[4].textContent = total.l;

  // Chart
  const dates = Object.keys(daily).sort();
  const growth = dates.reduce((acc, date) => {
    const prev = acc.length ? acc[acc.length-1] : 0;
    return [...acc, prev + daily[date]];
  }, []);

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('growthChart'), {
    type: 'line',
    data: {
      labels: dates.map(d=>new Date(d).getDate()),
      datasets: [{
        label: 'Net Growth (Join - Leave)',
        data: growth,
        borderColor: '#ffcc00',
        backgroundColor: 'rgba(255,204,0,0.2)',
        borderWidth: 3,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {legend:{labels:{color:'#ffcc00'}}},
      scales: {
        x: {ticks:{color:'#b2b27d'}},
        y: {ticks:{color:'#b2b27d'}, grid:{color:'rgba(107,142,35,0.3)'}}
      }
    }
  });
}
</script>
